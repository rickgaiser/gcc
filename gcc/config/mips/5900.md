;; Copyright (C) 2002-2015 Free Software Foundation, Inc.
;;
;; This file is part of GCC.
;;
;; GCC is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation; either version 3, or (at your option)
;; any later version.
;;
;; GCC is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with GCC; see the file COPYING3.  If not see
;; <http://www.gnu.org/licenses/>.
;;
;; R5900 instruction patterns and pipeline tuning.

(define_automaton "r5900_alu,r5900_mac,r5900_fpu,r5900_br,r5900_ls")

(define_cpu_unit "r5900_alu0,r5900_alu1" "r5900_alu")
(define_cpu_unit "r5900_mac" "r5900_mac")
(define_cpu_unit "r5900_c1" "r5900_fpu")
(define_cpu_unit "r5900_br" "r5900_br")
(define_cpu_unit "r5900_ls" "r5900_ls")

(define_insn_reservation "r5900_alu" 1
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "unknown,prefetch,prefetchx,condmove,const,arith,
			shift,slt,clz,trap,multi,nop,logical,signext,move"))
 "r5900_alu0|r5900_alu1")

(define_insn_reservation "r5900_loadstore" 1
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "load,store"))
 "r5900_ls")

(define_insn_reservation "r5900_fploadstore" 2
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "fpload,fpstore"))
 "r5900_c1*2")

(define_insn_reservation "r5900_fcvt" 4
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "fcvt"))
 "r5900_c1*4")

(define_insn_reservation "r5900_fmove" 4
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "fabs,fneg,fmove"))
 "r5900_c1*4")

(define_insn_reservation "r5900_fcmp" 4
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "fcmp"))
 "r5900_c1*4")

(define_insn_reservation "r5900_fadd" 4
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "fadd"))
 "r5900_c1*4")

(define_insn_reservation "r5900_fmul_single" 4
  (and (eq_attr "cpu" "r5900")
       (and (eq_attr "type" "fmul,fmadd")
            (eq_attr "mode" "SF")))
 "r5900_c1*4")

(define_insn_reservation "r5900_fdiv_single" 8
  (and (eq_attr "cpu" "r5900")
       (and (eq_attr "type" "fdiv,frdiv")
            (eq_attr "mode" "SF")))
 "r5900_c1*8")

(define_insn_reservation "r5900_fsqrt_single" 8
  (and (eq_attr "cpu" "r5900")
       (and (eq_attr "type" "fsqrt")
            (eq_attr "mode" "SF")))
 "r5900_c1*8")

(define_insn_reservation "r5900_frsqrt_single" 15
  (and (eq_attr "cpu" "r5900")
       (and (eq_attr "type" "frsqrt")
            (eq_attr "mode" "SF")))
 "r5900_c1*14")

(define_insn_reservation "r5900_xfer" 2
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "mfc,mtc"))
 "r5900_alu0|r5900_alu1")

(define_insn_reservation "r5900_branch" 1
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "branch,jump,call"))
 "r5900_br")

(define_insn_reservation "r5900_hilo" 1
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "mfhi,mflo,mthi,mtlo"))
 "r5900_mac")

(define_insn_reservation "r5900_hilo1" 1
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "mfhi1,mflo1,mthi1,mtlo1"))
 "r5900_mac")

(define_insn_reservation "r5900_philo" 1
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "pmfhl"))
 "r5900_mac")

(define_insn_reservation "r5900_imul" 4
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "imul,imul3,imadd"))
 "r5900_mac*4")

(define_insn_reservation "r5900_idiv" 37
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "idiv,idiv3"))
 "r5900_mac*37")

(define_insn_reservation "r5900_alu_wide" 1
  (and (eq_attr "cpu" "r5900")
       (eq_attr "type" "parith,plogical,pshift"))
 "r5900_alu0+r5900_alu1")

;; 128-bit vectors of words, halfwords and bytes.
(define_mode_iterator MMI_VWHB [V4SI V8HI V16QI])

;; 128-bit vectors of words and halfwords
(define_mode_iterator MMI_VWH [V4SI V8HI])

;; 128-bit vectors of halfwords and bytes
(define_mode_iterator MMI_VHB [V8HI V16QI])

;; Mapping of the 128-bit vector modes to their corresponding scalar modes
(define_mode_attr MMI_VWHB_SCAL [(V16QI "QI") (V8HI "HI") (V4SI "SI")])

;; Suffixes corresponding to the modes from the MMI_VWHB iterator.
(define_mode_attr mmi_suffix [(V4SI "w") (V8HI "h") (V16QI "b")])

;; Vector-mode comparison operators
(define_code_iterator MMI_VCMP_OP [eq gt])
(define_code_iterator VCMP_OP [eq ne ge gt lt le])
(define_code_attr mmi_vcmp_op [(eq "eq") (gt "gt")])

;; Corresponding vectors for packing operations
(define_mode_attr MMI_VWH_PAC [(V8HI "V16QI") (V4SI "V8HI")])

;; Double-sized modes for packing operations
(define_mode_attr MMI_VWH_PAC2 [(V8HI "V16HI") (V4SI "V8SI")])

;; Corresponding vectors for unpacking operations
(define_mode_attr MMI_VWHB_UNPAC [(V16QI "V8HI") (V8HI "V4SI") (V4SI "V2DI")])

;; Expander to legitimize moves involving values of vector modes.
(define_expand "mov<mode>"
  [(set (match_operand:MMI_VWHB 0)
	(match_operand:MMI_VWHB 1))]
  "TARGET_MIPS5900"
{
  if (mips_legitimize_move (<MODE>mode, operands[0], operands[1]))
    DONE;
})

;; Handle legitimized moves between values of vector modes.
(define_insn "mov<mode>_internal"
  [(set (match_operand:MMI_VWHB 0 "nonimmediate_operand" "=d,m,d,d,l")
	(match_operand:MMI_VWHB 1 "move_operand"         " d,d,m,l,d"))]
  "TARGET_MIPS5900"
  { return mips_output_move (operands[0], operands[1]); }
  [(set_attr "move_type" "move,store,load,mflo,mtlo")])

;; RSQRT
(define_insn "rsqrtsf"
  [(set (match_operand:SF 0 "register_operand" "=f")
	(div:SF (match_operand:SF 1 "register_operand" "f")
		  (sqrt:SF (match_operand:SF 2 "register_operand" "f"))))]
  "TARGET_MIPS5900"
  "rsqrt.s\t%0,%1,%2"
  [(set_attr "type" "frsqrt")
   (set_attr "mode" "SF")])

;; MIN and MAX
(define_insn "sminsf3"
  [(set (match_operand:SF 0 "register_operand" "=f")
	(smin:SF (match_operand:SF 1 "register_operand" "f")
		 (match_operand:SF 2 "register_operand" "f")))]
  "TARGET_MIPS5900"
  "min.s\t%0,%1,%2"
  [(set_attr "type" "fadd")])

(define_insn "smaxsf3"
  [(set (match_operand:SF 0 "register_operand" "=f")
	(smax:SF (match_operand:SF 1 "register_operand" "f")
		 (match_operand:SF 2 "register_operand" "f")))]
  "TARGET_MIPS5900"
  "max.s\t%0,%1,%2"
  [(set_attr "type" "fadd")
   (set_attr "mode" "SF")])

(define_insn "smin<mode>3"
  [(set (match_operand:MMI_VWH 0 "register_operand" "=d")
	(smin:MMI_VWH (match_operand:MMI_VWH 1 "register_operand" "d")
		      (match_operand:MMI_VWH 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "pmin<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type" "parith")])

(define_insn "smax<mode>3"
  [(set (match_operand:MMI_VWH 0 "register_operand" "=d")
	(smax:MMI_VWH (match_operand:MMI_VWH 1 "register_operand" "d")
		      (match_operand:MMI_VWH 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "pmax<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type" "parith")])

;; Logical MMI
(define_insn "ior<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(ior:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		    (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "por\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "xor<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(xor:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		    (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "pxor\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "nor<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(and:MMI_VWHB (not:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d"))
		 (not:MMI_VWHB (match_operand:MMI_VWHB 2 "register_operand" "d"))))]
  "TARGET_MIPS5900"
  "pnor\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "one_cmpl<mode>2"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(not:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "pnor\t%0,%.,%1"
  [(set_attr "type" "plogical")])

(define_insn "and<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(and:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		    (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "pand\t%0,%1,%2"
  [(set_attr "type" "plogical")])

;; Arithmetic MMI
(define_insn "add<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
        (plus:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		       (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "padd<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type"	"parith")])

(define_insn "sub<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
        (minus:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		        (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "psub<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type"	"parith")])

;; Arithmetic MMI - signed saturation
(define_insn "ssadd<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
        (ss_plus:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		          (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "padds<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type"	"parith")])

(define_insn "sssub<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
        (ss_minus:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		           (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "psubs<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type"	"parith")])

;; Arithmetic MMI - unsigned saturation
(define_insn "usadd<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
        (us_plus:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		          (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "paddu<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type"	"parith")])

(define_insn "ussub<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
        (us_minus:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		           (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "psubu<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type"	"parith")])

;; Comparisons
(define_insn "pc<MMI_VCMP_OP:code><MMI_VWHB:mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
        (MMI_VCMP_OP:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		  	      (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "pc<MMI_VCMP_OP:code><mmi_suffix>\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_expand "vec_cmpge<MMI_VWHB:mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(ge:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		     (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
{
  emit_insn (gen_pcgt<mode> (operands[0], operands[2], operands[1]));
  emit_insn (gen_one_cmpl<mode>2 (operands[0], operands[0]));
  DONE;
})

(define_expand "vec_cmpeq<MMI_VWHB:mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(eq:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		     (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
{
  emit_insn (gen_pceq<mode> (operands[0], operands[1], operands[2]));
  DONE;
})

(define_expand "vec_cmpgt<MMI_VWHB:mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(gt:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		     (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
{
  emit_insn (gen_pcgt<mode> (operands[0], operands[1], operands[2]));
  DONE;
})

(define_expand "vec_cmplt<MMI_VWHB:mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(lt:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		     (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
{
  emit_insn (gen_pcgt<mode> (operands[0], operands[2], operands[1]));
  DONE;
})

(define_expand "vec_cmple<MMI_VWHB:mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(le:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		     (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
{
  emit_insn (gen_pcgt<mode> (operands[0], operands[1], operands[2]));
  emit_insn (gen_one_cmpl<mode>2 (operands[0], operands[0]));
  DONE;
}) 

(define_expand "vec_cmpne<MMI_VWHB:mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(ne:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
		     (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
{
  emit_insn (gen_pceq<mode> (operands[0], operands[1], operands[2]));
  emit_insn (gen_one_cmpl<mode>2 (operands[0], operands[0]));
  DONE;
})

(define_expand "vcond<mode><mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(if_then_else:MMI_VWHB
	 (match_operator 3 "comparison_operator"
			 [(match_operand:MMI_VWHB 4 "register_operand" "d")
			  (match_operand:MMI_VWHB 5 "register_operand" "d")])
	 (match_operand:MMI_VWHB 1 "register_operand" "d")
	 (match_operand:MMI_VWHB 2 "register_operand" "d")))]
  "TARGET_MIPS5900"
  "
{
  if (r5900_emit_vcond_expr (operands[0], operands[1], operands[2],
			     operands[3], operands[4], operands[5]))
    DONE;
  else
    FAIL;
}")

;; Internal pattern, used by the vcond expander above.
(define_expand "vcond<MMI_VCMP_OP:mmi_vcmp_op><MMI_VWHB:mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(ior:MMI_VWHB (and:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
				    (MMI_VCMP_OP:MMI_VWHB (match_operand:MMI_VWHB 3 "register_operand" "d")
							  (match_operand:MMI_VWHB 4 "register_operand" "d")))
		      (and:MMI_VWHB (match_operand:MMI_VWHB 2 "register_operand" "d")
				    (neg:MMI_VWHB (MMI_VCMP_OP:MMI_VWHB (match_dup 3)
									(match_dup 4))))))]
  "TARGET_MIPS5900"
{
  machine_mode mode = GET_MODE (operands[3]);
  rtx value1, value2, mask;

  value1 = gen_reg_rtx (mode);
  value2 = gen_reg_rtx (mode);
  mask = gen_reg_rtx (mode);
  emit_insn (gen_pc<MMI_VCMP_OP:mmi_vcmp_op><mode> (mask, operands[3], operands[4]));
  emit_insn (gen_and<mode>3 (value1, mask, operands[1]));
  emit_insn (gen_one_cmpl<mode>2 (mask, mask));
  emit_insn (gen_and<mode>3 (value2, mask, operands[2]));
  emit_insn (gen_ior<mode>3 (operands[0], value1, value2));
  DONE;
})

;; Shifting MMI
(define_insn "ashr<mode>3"
  [(set (match_operand:MMI_VWH 0 "register_operand" "=d")
        (ashiftrt:MMI_VWH (match_operand:MMI_VWH 1 "register_operand" "d")
		      (match_operand 2 "const_int_operand")))]
  "TARGET_MIPS5900"
  "psra<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type" "pshift")])

(define_insn "lshr<mode>3"
  [(set (match_operand:MMI_VWH 0 "register_operand" "=d")
        (lshiftrt:MMI_VWH (match_operand:MMI_VWH 1 "register_operand" "d")
		          (match_operand 2 "const_int_operand")))]
  "TARGET_MIPS5900"
  "psrl<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type" "pshift")])

(define_insn "ashl<mode>3"
  [(set (match_operand:MMI_VWH 0 "register_operand" "=d")
        (ashift:MMI_VWH (match_operand:MMI_VWH 1 "register_operand" "d")
		        (match_operand 2 "const_int_operand")))]
  "TARGET_MIPS5900"
  "psll<mmi_suffix>\t%0,%1,%2"
  [(set_attr "type" "pshift")])

;; Multiplication MMI
/*	RD: A6xB6, A4xB4, A2xB2, A0xA0
	LO: A7xB7, A6xB6, A3xB3, A2xA2
	HI: A5xB5, A4xB4, A1xB1, A0xA0	*/
(define_insn "pmulth"
  [(set (match_operand:V8SI 0 "hilo_operand" "=x")
        (vec_select:V8SI (mult:V8SI (sign_extend:V8SI (match_operand:V8HI 1 "register_operand" "d"))
			            (sign_extend:V8SI (match_operand:V8HI 2 "register_operand" "d")))
		         (parallel[(const_int 0) (const_int 1) (const_int 4) (const_int 5)
				   (const_int 2) (const_int 3) (const_int 6) (const_int 7)])))
   (clobber (match_scratch:V4SI 3 "=d"))]
  "TARGET_MIPS5900"
  "pmulth\t%3,%1,%2"
  [(set_attr "type" "imul")])

(define_insn "pmfhl_lh"
  [(set (match_operand:V8HI 0 "register_operand" "=d")
	(vec_select:V8HI (match_operand:V16HI 1 "hilo_operand" "x")
			 (parallel[(const_int 0) (const_int 2) (const_int 8) (const_int 10)
				   (const_int 4) (const_int 6) (const_int 12) (const_int 14)])))]
  "TARGET_MIPS5900"
  "pmfhl.lh\t%0"
  [(set_attr "type" "pmfhl")])

(define_expand "mulv8hi3"
  [(set (match_operand:V8HI 0 "register_operand")
        (mult:V8HI (match_operand:V8HI 1 "register_operand")
		   (match_operand:V8HI 2 "register_operand")))]
  "TARGET_MIPS5900"
{
	rtx hilo;

	hilo = gen_rtx_REG (V8SImode, MD_REG_FIRST);

	emit_insn (gen_pmulth (hilo, operands[1], operands[2]));
	hilo = simplify_gen_subreg (V16HImode, hilo, V8SImode, 0);
	emit_insn (gen_pmfhl_lh (operands[0], hilo));

	DONE;
})

(define_insn "pmflo"
  [(set (match_operand:V4SI 0 "register_operand" "=d")
        (vec_select:V4SI (match_operand:V8SI 1 "hilo_operand" "x")
			 (parallel[(const_int 0) (const_int 1) (const_int 2) (const_int 3)])))]
  "TARGET_MIPS5900"
  "pmflo\t%1"
  [(set_attr "type" "pmfhl")])

(define_insn "pmfhi"
  [(set (match_operand:V4SI 0 "register_operand" "=d")
        (vec_select:V4SI (match_operand:V8SI 1 "hilo_operand" "x")
			 (parallel[(const_int 4) (const_int 5) (const_int 6) (const_int 7)])))]
  "TARGET_MIPS5900"
  "pmfhi\t%0"
  [(set_attr "type" "pmfhl")])

(define_insn "pcpyldv16qi"
  [(set (match_operand:V16QI 0 "register_operand" "=d")
        (vec_concat:V16QI (vec_select:V8QI (match_operand:V16QI 1 "register_operand" "d")
					   (parallel[(const_int 0) (const_int 1) (const_int 2) (const_int 3)
						     (const_int 4) (const_int 5) (const_int 6) (const_int 7)]))
		          (vec_select:V8QI (match_operand:V16QI 2 "register_operand" "d")
					   (parallel[(const_int 0) (const_int 1) (const_int 2) (const_int 3)
						     (const_int 4) (const_int 5) (const_int 6) (const_int 7)]))))]
  "TARGET_MIPS5900"
  "pcpyld\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "pcpyldv8hi"
  [(set (match_operand:V8HI 0 "register_operand" "=d")
        (vec_concat:V8HI (vec_select:V4HI (match_operand:V8HI 1 "register_operand" "d")
					  (parallel[(const_int 0) (const_int 1) (const_int 2) (const_int 3)]))
		         (vec_select:V4HI (match_operand:V8HI 2 "register_operand" "d")
					  (parallel[(const_int 0) (const_int 1) (const_int 2) (const_int 3)]))))]
  "TARGET_MIPS5900"
  "pcpyld\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "pcpyldv4si"
  [(set (match_operand:V4SI 0 "register_operand" "=d")
        (vec_concat:V4SI (vec_select:V2SI (match_operand:V4SI 1 "register_operand" "d")
					  (parallel[(const_int 0) (const_int 1)]))
		         (vec_select:V2SI (match_operand:V4SI 2 "register_operand" "d")
					  (parallel[(const_int 0) (const_int 1)]))))]
  "TARGET_MIPS5900"
  "pcpyld\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "pcpyudv8hi"
  [(set (match_operand:V8HI 0 "register_operand" "=d")
        (vec_concat:V8HI (vec_select:V4HI (match_operand:V8HI 1 "register_operand" "d")
					  (parallel[(const_int 4) (const_int 5) (const_int 6) (const_int 7)]))
		         (vec_select:V4HI (match_operand:V8HI 2 "register_operand" "d")
					  (parallel[(const_int 4) (const_int 5) (const_int 6) (const_int 7)]))))]
  "TARGET_MIPS5900"
  "pcpyud\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_expand "vec_widen_smult_hi_v8hi"
  [(set (match_operand:V4SI 0 "register_operand")
        (mult:V8HI (match_operand:V8HI 1 "register_operand")
		   (match_operand:V8HI 2 "register_operand")))]
  "TARGET_MIPS5900"
{
	rtx hilo, lo_gpr, hi_gpr;

	hilo = gen_rtx_REG (V8SImode, MD_REG_FIRST);
	lo_gpr = gen_reg_rtx (V4SImode);
	hi_gpr = gen_reg_rtx (V4SImode);
	emit_insn (gen_pmulth (hilo, operands[1], operands[2]));
	emit_insn (gen_pmfhi (hi_gpr, hilo));
	emit_insn (gen_pmflo (lo_gpr, hilo));
	emit_insn (gen_pcpyldv8hi (operands[0], lo_gpr, hi_gpr));

	DONE;
})

(define_expand "vec_widen_smult_lo_v8hi"
  [(set (match_operand:V4SI 0 "register_operand")
        (mult:V8HI (match_operand:V8HI 1 "register_operand")
		   (match_operand:V8HI 2 "register_operand")))]
  "TARGET_MIPS5900"
{
	rtx hilo, lo_gpr, hi_gpr;

	hilo = gen_rtx_REG (V8SImode, MD_REG_FIRST);
	lo_gpr = gen_reg_rtx (V4SImode);
	hi_gpr = gen_reg_rtx (V4SImode);
	emit_insn (gen_pmulth (hilo, operands[1], operands[2]));
	emit_insn (gen_pmfhi (hi_gpr, hilo));
	emit_insn (gen_pmflo (lo_gpr, hilo));
	emit_insn (gen_pcpyudv8hi (operands[0], hi_gpr, lo_gpr));

	DONE;
})

;; Vector rotation MMI

(define_insn "mtsa<mode>3"
  [(set (match_operand:SI 0 "sa_operand" "=ws")
	(match_operand:SI 1 "const_int_operand" ""))
   (match_operand:MMI_VHB 2 "register_operand" "d")]
  "TARGET_MIPS5900"
  "mtsa<mmi_suffix>\t%2,%1"
  [(set_attr "type" "logical")])

(define_insn "qfsrv<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "=d")
	(rotatert:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
			   (match_operand:SI 2 "sa_operand" "ws")))]
  "TARGET_MIPS5900"
  "qfsrv\t%0,%1,%1"
  [(set_attr "type" "pshift")])

(define_expand "rotr<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand")
	(rotatert:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand")
			   (match_operand 2 "const_int_operand")))]
  "TARGET_MIPS5900"
{
  rtx sa = gen_rtx_REG (SImode, SA_REGNUM);
  machine_mode inner_mode = GET_MODE_INNER (GET_MODE (operands[1]));

  switch (inner_mode)
    {
      case QImode:
        emit_insn (gen_mtsav16qi3 (sa, operands[2], gen_rtx_REG (V16QImode, GP_REG_FIRST)));
        break;
      case HImode:
        emit_insn (gen_mtsav8hi3 (sa, operands[2], gen_rtx_REG (V8HImode, GP_REG_FIRST)));
        break;
      case SImode:
        emit_insn (gen_mtsav8hi3 (sa, GEN_INT (INTVAL (operands[2]) * 2), gen_rtx_REG (V8HImode, GP_REG_FIRST)));
        break;
      default:
        FAIL;
    }

  emit_insn (gen_qfsrv<mode>3 (operands[0], operands[1], sa));
  DONE;
})

(define_expand "rotl<mode>3"
  [(set (match_operand:MMI_VWHB 0 "register_operand")
	(rotate:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand")
		         (match_operand 2 "const_int_operand")))]
  "TARGET_MIPS5900"
{
  rtx sa = gen_rtx_REG (SImode, SA_REGNUM);
  machine_mode inner_mode = GET_MODE_INNER (GET_MODE (operands[1]));

  switch (inner_mode)
    {
      case QImode:
        emit_insn (gen_mtsav16qi3 (sa, GEN_INT (16 - INTVAL (operands[2])), gen_rtx_REG (V16QImode, GP_REG_FIRST)));
        break;
      case HImode:
        emit_insn (gen_mtsav8hi3 (sa, GEN_INT (16 - INTVAL (operands[2])), gen_rtx_REG (V8HImode, GP_REG_FIRST)));
        break;
      case SImode:
        emit_insn (gen_mtsav8hi3 (sa, GEN_INT ((16 - INTVAL (operands[2])) * 2), gen_rtx_REG (V8HImode, GP_REG_FIRST)));
        break;
      default:
        FAIL;
    }

  emit_insn (gen_qfsrv<mode>3 (operands[0], operands[1], sa));
  DONE;
})

;; Vector initialization MMI

(define_expand "vec_init<mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand")
	(parallel [(match_operand 1 "const_int_operand")]))]
  "TARGET_MIPS5900"
{
  mips_expand_vector_init (operands[0], operands[1]);
  DONE;
})

(define_expand "vec_extract<mode>"
  [(set (match_operand:<MMI_VWHB_SCAL> 0 "register_operand" "=d")
	(truncate:<MMI_VWHB_SCAL> (vec_select:MMI_VWHB (match_operand:MMI_VWHB 1 "register_operand" "d")
			  			       (parallel [(match_operand 2 "const_int_operand" "")]))))]
  "TARGET_MIPS5900"
{
  machine_mode inner_mode = GET_MODE_INNER (GET_MODE (operands[1]));
  rtx rotated, result, mask;

  if (INTVAL(operands[2]) > 0)
    {
      rotated = gen_reg_rtx (GET_MODE (operands[1]));
      emit_insn (gen_rotr<mode>3 (rotated, operands[1], operands[2]));
    }
  else
    rotated = operands[1];

  rotated = simplify_gen_subreg (SImode, rotated, GET_MODE (rotated), 0);
  result = simplify_gen_subreg (SImode, operands[0], GET_MODE (operands[0]), 0);
  switch (inner_mode)
    {
      case QImode:
        emit_insn (gen_andsi3 (result, rotated, GEN_INT (0xff)));
        break;
      case HImode:
        emit_insn (gen_andsi3 (result, rotated, GEN_INT (0xffff)));
        break;
      case SImode:
        mask = gen_reg_rtx (SImode);
        mips_emit_move (mask, GEN_INT (0xffffffff));
        emit_insn (gen_andsi3 (result, rotated, mask));
        break;
      default:
        FAIL;
    }
  DONE;
})

(define_expand "vec_set<mode>"
  [(set (match_operand:MMI_VWHB 0 "register_operand" "+d")
	(zero_extend:MMI_VWHB (match_operand:<MMI_VWHB_SCAL> 1 "register_operand" "d")))
   (match_operand 2 "const_int_operand" "")]
  "TARGET_MIPS5900"
{
  machine_mode mode = GET_MODE (operands[0]);
  rtx rotated, mask;

  mask = gen_reg_rtx (SImode);
  switch (mode)
    {
      case V16QImode:
        mips_emit_move (mask, GEN_INT (0xff));
        break;
      case V8HImode:
        mips_emit_move (mask, GEN_INT (0xffff));
        break;
      case V4SImode:
        mips_emit_move (mask, GEN_INT (0xffffffff));
        break;
      default:
        FAIL;
    }

  mask = simplify_gen_subreg (mode, mask, SImode, 0);
  emit_insn (gen_one_cmpl<mode>2 (mask, mask));
  rotated = simplify_gen_subreg (mode, operands[1], GET_MODE (operands[1]), 0);
  if (INTVAL(operands[2]) > 0)
    {
      emit_insn (gen_rotl<mode>3 (rotated, rotated, operands[2]));
      emit_insn (gen_rotl<mode>3 (mask, mask, operands[2]));
    }

  emit_insn (gen_and<mode>3 (operands[0], operands[0], mask));
  emit_insn (gen_ior<mode>3 (operands[0], operands[0], rotated));

  DONE;
})

;; Packing MMI

(define_insn "vec_pack_trunc_<mode>"
  [(set (match_operand:<MMI_VWH_PAC> 0 "register_operand" "=d")
	(truncate:<MMI_VWH_PAC> (vec_concat:<MMI_VWH_PAC2> (match_operand:MMI_VWH 1 "register_operand" "d")
							   (match_operand:MMI_VWH 2 "register_operand" "d"))))]
  "TARGET_MIPS5900"
  "ppac<mmi_suffix>\t%0,%2,%1"
  [(set_attr "type" "plogical")])

;; Unpacking MMI

(define_insn "pextlv16qi3"
  [(set (match_operand:V16QI 0 "register_operand" "=d")
	(vec_select:V16QI (vec_concat:V32QI (match_operand:V16QI 1 "register_operand" "d")
					    (match_operand:V16QI 2 "register_operand" "d"))
			  (parallel[(const_int 16) (const_int 0) (const_int 17) (const_int 1)
				    (const_int 18) (const_int 2) (const_int 19) (const_int 3)
				    (const_int 20) (const_int 4) (const_int 21) (const_int 5)
				    (const_int 22) (const_int 6) (const_int 23) (const_int 7)])))]
  "TARGET_MIPS5900"
  "pextlb\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "pextuv16qi3"
  [(set (match_operand:V16QI 0 "register_operand" "=d")
	(vec_select:V16QI (vec_concat:V32QI (match_operand:V16QI 1 "register_operand" "d")
					    (match_operand:V16QI 2 "register_operand" "d"))
			  (parallel[(const_int 24) (const_int 8) (const_int 25) (const_int 9)
				    (const_int 26) (const_int 10) (const_int 27) (const_int 11)
				    (const_int 28) (const_int 12) (const_int 29) (const_int 13)
				    (const_int 30) (const_int 14) (const_int 31) (const_int 15)])))]
  "TARGET_MIPS5900"
  "pextub\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "pextlv8hi3"
  [(set (match_operand:V8HI 0 "register_operand" "=d")
	(vec_select:V8HI (vec_concat:V16HI (match_operand:V8HI 1 "register_operand" "d")
					   (match_operand:V8HI 2 "register_operand" "d"))
			 (parallel[(const_int 8) (const_int 0) (const_int 9) (const_int 1)
				   (const_int 10) (const_int 2) (const_int 11) (const_int 3)])))]
  "TARGET_MIPS5900"
  "pextlh\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "pextuv8hi3"
  [(set (match_operand:V8HI 0 "register_operand" "=d")
	(vec_select:V8HI (vec_concat:V16HI (match_operand:V8HI 1 "register_operand" "d")
					   (match_operand:V8HI 2 "register_operand" "d"))
			 (parallel[(const_int 12) (const_int 4) (const_int 13) (const_int 5)
				   (const_int 14) (const_int 6) (const_int 15) (const_int 7)])))]
  "TARGET_MIPS5900"
  "pextuh\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "pextlv4si3"
  [(set (match_operand:V4SI 0 "register_operand" "=d")
	(vec_select:V4SI (vec_concat:V8SI (match_operand:V4SI 1 "register_operand" "d")
					  (match_operand:V4SI 2 "register_operand" "d"))
			 (parallel[(const_int 4) (const_int 0) (const_int 5) (const_int 1)])))]
  "TARGET_MIPS5900"
  "pextlw\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_insn "pextuv4si3"
  [(set (match_operand:V4SI 0 "register_operand" "=d")
	(vec_select:V4SI (vec_concat:V8SI (match_operand:V4SI 1 "register_operand" "d")
					   (match_operand:V4SI 2 "register_operand" "d"))
			 (parallel[(const_int 6) (const_int 2) (const_int 7) (const_int 3)])))]
  "TARGET_MIPS5900"
  "pextuw\t%0,%1,%2"
  [(set_attr "type" "plogical")])

(define_expand "vec_unpacku_lo_<mode>"
  [(set (match_operand:<MMI_VWHB_UNPAC> 0 "register_operand" "=d")
	(zero_extend:<MMI_VWHB_UNPAC> (match_operand:MMI_VWHB 1 "register_operand" "d")))]
  "TARGET_MIPS5900"
{
  machine_mode mode = GET_MODE (operands[1]);

  switch (mode)
    {
      case V16QImode:
        emit_insn (gen_pextlv16qi3 (operands[0], gen_rtx_REG (mode, GP_REG_FIRST), operands[1]));
        DONE;
      case V8HImode:
        emit_insn (gen_pextlv8hi3 (operands[0], gen_rtx_REG (mode, GP_REG_FIRST), operands[1]));
        DONE;
      case V4SImode:
        emit_insn (gen_pextlv4si3 (operands[0], gen_rtx_REG (mode, GP_REG_FIRST), operands[1]));
        DONE;
      default:
       FAIL;
    }
})

(define_expand "vec_unpacku_hi_<mode>"
  [(set (match_operand:<MMI_VWHB_UNPAC> 0 "register_operand")
	(zero_extend:<MMI_VWHB_UNPAC> (match_operand:MMI_VWHB 1 "register_operand")))]
  "TARGET_MIPS5900"
{
  machine_mode mode = GET_MODE (operands[1]);

  switch (mode)
    {
      case V16QImode:
        emit_insn (gen_pextuv16qi3 (operands[0], gen_rtx_REG (mode, GP_REG_FIRST), operands[1]));
        DONE;
      case V8HImode:
        emit_insn (gen_pextuv8hi3 (operands[0], gen_rtx_REG (mode, GP_REG_FIRST), operands[1]));
        DONE;
      case V4SImode:
        emit_insn (gen_pextuv4si3 (operands[0], gen_rtx_REG (mode, GP_REG_FIRST), operands[1]));
        DONE;
      default:
       FAIL;
    }
})

(define_expand "vec_unpacks_lo_<mode>"
  [(set (match_operand:<MMI_VWHB_UNPAC> 0 "register_operand")
	(sign_extend:<MMI_VWHB_UNPAC> (match_operand:MMI_VWHB 1 "register_operand")))]
  "TARGET_MIPS5900"
{
  rtx sign_extend;
  machine_mode mode = GET_MODE (operands[1]);

  sign_extend = gen_reg_rtx(mode);
  emit_insn (gen_pcgt<mode> (sign_extend, gen_rtx_REG (mode, GP_REG_FIRST), operands[1]));

  switch (mode)
    {
      case V16QImode:
        emit_insn (gen_pextlv16qi3 (operands[0], sign_extend, operands[1]));
        DONE;
      case V8HImode:
        emit_insn (gen_pextlv8hi3 (operands[0], sign_extend, operands[1]));
        DONE;
      case V4SImode:
        emit_insn (gen_pextlv4si3 (operands[0], sign_extend, operands[1]));
        DONE;
      default:
       FAIL;
    }
})

(define_expand "vec_unpacks_hi_<mode>"
  [(set (match_operand:<MMI_VWHB_UNPAC> 0 "register_operand")
	(sign_extend:<MMI_VWHB_UNPAC> (match_operand:MMI_VWHB 1 "register_operand")))]
  "TARGET_MIPS5900"
{
  rtx sign_extend;
  machine_mode mode = GET_MODE (operands[1]);

  sign_extend = gen_reg_rtx(mode);
  emit_insn (gen_pcgt<mode> (sign_extend, gen_rtx_REG (mode, GP_REG_FIRST), operands[1]));

  switch (mode)
    {
      case V16QImode:
        emit_insn (gen_pextuv16qi3 (operands[0], sign_extend, operands[1]));
        DONE;
      case V8HImode:
        emit_insn (gen_pextuv8hi3 (operands[0], sign_extend, operands[1]));
        DONE;
      case V4SImode:
        emit_insn (gen_pextuv4si3 (operands[0], sign_extend, operands[1]));
        DONE;
      default:
       FAIL;
    }
})

;; Multiply Add/Subtract MMI
;; FIXME: All patterns here are not working

(define_insn "maddv8hiv8si4"
  [(set (match_operand:V8SI 0 "register_operand" "=x")
	(plus:V8SI (mult:V8SI (sign_extend:V8SI (match_operand:V8HI 1 "register_operand" "d"))
			      (sign_extend:V8SI (match_operand:V8HI 2 "register_operand" "d")))
		   (match_operand:V8SI 3 "register_operand" "x")))]
  "TARGET_MIPS5900"
  "pmaddh\t%.,%1,%2"
  [(set_attr "type"	"imadd")
   (set_attr "accum_in"	"3")])

(define_expand "maddv8hiv8hi4"
  [(set (match_operand:V8HI 0 "register_operand" "=d")
	(truncate:V8HI (plus:V8SI (mult:V8SI (sign_extend:V8SI (match_operand:V8HI 1 "register_operand" "d"))
					     (sign_extend:V8SI (match_operand:V8HI 2 "register_operand" "d")))
				  (match_operand:V8SI 3 "register_operand" "x"))))]
  "TARGET_MIPS5900"
{
    rtx hilo;
    hilo = gen_rtx_REG (V8SImode, MD_REG_FIRST);
    emit_insn (gen_maddv8hiv8si4 (hilo, operands[1], operands[2], operands[3]));
    emit_insn (gen_pmfhl_lh (operands[0], hilo));
    DONE;
})

(define_insn "msubv8hiv8si4"
  [(set (match_operand:V8SI 0 "register_operand" "=x")
	(minus:V8SI (mult:V8SI (sign_extend:V8SI (match_operand:V8HI 1 "register_operand" "d"))
			       (sign_extend:V8SI (match_operand:V8HI 2 "register_operand" "d")))
		    (match_operand:V8SI 3 "register_operand" "x")))]
  "TARGET_MIPS5900"
  "pmsubh\t%.,%1,%2"
  [(set_attr "type"	"imadd")
   (set_attr "accum_in"	"3")])

(define_expand "msubv8hiv8hi4"
  [(set (match_operand:V8HI 0 "register_operand" "=d")
	(truncate:V8HI (minus:V8SI (mult:V8SI (sign_extend:V8SI (match_operand:V8HI 1 "register_operand" "d"))
					      (sign_extend:V8SI (match_operand:V8HI 2 "register_operand" "d")))
				   (match_operand:V8SI 3 "register_operand" "x"))))]
  "TARGET_MIPS5900"
{
    rtx hilo;
    hilo = gen_rtx_REG (V8SImode, MD_REG_FIRST);
    emit_insn (gen_msubv8hiv8si4 (hilo, operands[1], operands[2], operands[3]));
    emit_insn (gen_pmfhl_lh (operands[0], hilo));
    DONE;
})
